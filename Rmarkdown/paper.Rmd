---
title: "Comparing corrosion control treatments for drinking water using a robust Bayesian generalized additive model"
author: "Benjamin F. Trueman^§,\\*^, Wendell James^†^, Trevor Shu^†^, Evelyne Dor&eacute;^§^, and Graham A. Gagnon^§^"
date: "^§^Centre for Water Resources Studies, Department of Civil & Resource Engineering, Dalhousie University, 1360 Barrington St., Halifax, NS, CAN B3H 4R2    \n&nbsp;    \n&nbsp;^†^EPCOR Water Services, Edmonton, AB, CAN    \n&nbsp;    \n&nbsp;^\\*^Corresponding author: benjamin.trueman@dal.ca"
output:
  word_document:
    keep_md: no
    reference_docx: StylesTemplate.docx
  html_document: default
bibliography: references.bib
csl: environmental-science-and-technology.csl
---

<!-- to do: check figure order -->

```{r setup, include=FALSE}
here::i_am("Rmarkdown/paper.Rmd")
knitr::opts_chunk$set(echo = FALSE)
library("dplyr")
library("tidyr")
library("stringr")
library("janitor")
model_in <- readr::read_csv(here::here("data-clean/model_in.csv"))
fig7_summ <- readr::read_csv(here::here("data-clean/figure-7-summary.csv"))
```

# Abstract  

Pipe loop studies are used to evaluate corrosion control treatment, and updated regulatory guidance will ensure that they remain important for water quality management. But the data they generate are difficult to analyze: non-linear time-trends, non-detects, extreme values, and autocorrelation are common attributes that make popular methods, such as the *t*- or rank-sum tests, poor descriptive models. Here, we propose a model for pipe loop data that accommodates many of these difficult-to-model attributes: a robust Bayesian generalized additive model with continuous-time autoregressive errors. Our approach facilitates corrosion control treatment comparisons without the need for imputing non-detects or special handling of outliers. It is well-suited to describing nonlinear trends without overfitting, and it accounts for the reduced information content in autocorrelated time series. We demonstrate it using a four-year pipe loop study, with multiple pipe configurations and orthophosphate dosing protocols, finding that an initially high dose of orthophosphate (2 mg P L^-1^) that is subsequently lowered (0.75 mg P L^-1^) can yield lower lead release than an intermediate dose (1 mg P L^-1^) in the long term. 

## Keywords

GAM; time series analysis; censored data; pipe loop; Lead and Copper Rule 

# Introduction    

Pipe loop studies are used to model drinking water distribution systems, mainly for evaluating corrosion control treatment. The US EPA's Revised Lead and Copper Rule mandates them under certain conditions [@estessmargiassi_understanding_2020; @us2021national], and the data they generate will need to be analyzed. But pipe loop study data are inherently complex and there is a real risk of misinterpreting them. In particular, (1) non-linearity, (2) censoring, (3) autocorrelation, (4) irregular sampling frequency, and (5) outliers are difficult to model using standard approaches (Figure 1a).

## Non-linearity

Non-linear time trends and seasonal variation can be difficult to describe without over- or under-fitting. They can also make it difficult to identify a stable phase, as typical guidance for analyzing pipe loop study data suggests [@wysock_statistical_1995]. The most common methods for describing pipe loop data are usually inadequate to describe complex nonlinear variation [@simpson_modelling_2018].

## Censoring 

Censoring typically arises in pipe loop studies when analyte concentrations fall below the detection limit (i.e., left-censoring). Left-censoring is often addressed by substituting a constant for values below the detection limit and sometimes by removing the censored values. Neither approach is advisable as both introduce artificial patterns that can distort results, sometimes seriously [@helsel_statistics_2012]. Popular statistical tests (e.g., the paired t-test and its generalization, the one-way repeated measures ANOVA) cannot accommodate censoring [@helsel_statistics_2012]. The non-parametric rank-sum test does allow for left-censoring at one detection limit, but it is not adequate for more complex censoring schemes (e.g., multiple detection limits or interval censoring). Imputation methods such as regression on order statistics may be useful [@helsel_statistics_2012], but in a time series the censored data may be correlated, and imputation in the context of a full data model is usually preferable [@hopke_multiple_2001].

## Autocorrelation

Autocorrelation means the current state of the system depends on its history. For example, the effect of a perturbation to corrosion scale is evident for some time after the fact. From a statistical perspective, autocorrelation makes parameter estimates more uncertain by reducing the effective sample size (i.e., the information content of the sample) [@helsel_statistical; @gelman_bayesian_2014]. As a consequence, it inflates the probability of falsely rejecting null hypotheses [@helsel_statistical]. Autocorrelation is very likely to be a feature of any pipe loop study dataset where effluent from pipes is sampled repeatedly over time, but it is not discussed in popular guides for pipe loop data analysis [@wysock_statistical_1995; @kirmeyer1996corr]. Moreover, neither the t-test nor its non-parametric analogues account for autocorrelation explicitly [@helsel_statistical; @raadt_pressing_2019].

The effect of autocorrelation can be surprisingly large: 100 observations from a time series may provide no greater precision than 10 independent observations if the 100 are strongly correlated in time [@helsel_statistical]. That is, *n* autocorrelated observations provide less information than *n* independent observations, and the difference can be large if autocorrelation is strong [@gelman_bayesian_2014]. Accounting for autocorrelation can improve predictive accuracy, but if it is ignored, analysts run the risk of making incorrect decisions based on the data. 

## Irregular sampling frequency 

An irregular sampling frequency is common in pipe loop studies where various process interruptions preclude collecting a regular measurement series. Irregular sampling makes it more difficult to estimate the strength and structure of autocorrelation [@simpson_modelling_2018].

## Outliers

Extreme lead or copper concentrations---typically due to particle release---are often inconsistent with the normality assumption common to many popular statistical tests. Outliers are sometimes omitted in practice [@schock_causes_1990], but unless they represent measurement error or a separate population (e.g., a process error), it is usually preferable to use a statistical method that is robust against them [@helsel_statistical].

```{r figure-1, fig.cap="**Figure 1. (a)** An example time series from the study described in this paper; labels 1--5 denote attributes of the series presenting statistical modeling challenges. **(b)** Summary of the five components comprising the model fitted to pipe loop data."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-1.png"))
```

## A Bayesian approach 

The primary goal of a pipe loop study is to compare two or more corrosion control treatments [@wysock_statistical_1995]. But the data attributes outlined above can make it difficult to choose a statistical method from the suite that is commonly applied, given their fairly rigid assumptions. Often, a more flexible approach is required, and Bayesian methods are inherently flexible, since there is no need to derive the sampling distribution of an estimator [@kruschke_doing_2015]. 

Here, we propose a Bayesian generalized additive model for pipe loop study data that is sufficiently flexible for most pipe loop datasets. The collection of measurement series representing variation in a given parameter over time---often lead--- is represented as the sum of five components (Figure 1b): 

1. An average representing each pipe (all other components are centered on zero).
2. A smooth seasonal trend, whose strength depends on the magnitude of the seasonal variation in water quality and temperature (this component may not be necessary if there is no distinct seasonality, or if the series is too short to identify it).
3. A smooth global trend describing multi-year variation in the parameter of interest across all pipes.
4. A set of smooth pipe-specific trends that describe the deviations from the global multi-year trend particular to each pipe.
5. An autocorrelated error term.

Separation of the time-trend into multi-year and seasonal components allows for easier identification of a stable phase in the presence of significant seasonality, and separation of the multi-year trend into global and pipe-specific components facilitates trend estimation in the presence of censoring or where there are long data gaps in the series representing one or more pipes. In these instances, the model "borrows" information from the other time series. The autocorrelated error model improves the accuracy of parameter distributions and predictions, while helping to prevent overfitting [@simpson_modelling_2018]. And while time is the only covariate in our model, additional predictors can easily be added as smooth or linear functions. 

We demonstrate the model using the data from a four-year pipe loop study that included multiple pipe configurations and orthophosphate dosing protocols. Our model accommodates censored observations without imputation and is robust against extreme analyte concentrations due to particle release---meaning that no special treatment of outliers is necessary. 

We use the model to (1) compare corrosion control treatments in terms of dissolved and particulate lead, (2) compare their relative contributions to total lead release, and (3) identify periods of stable lead release by considering the rate of change in the global multi-year term. 

An advantage of our approach is the ability to move beyond point estimates and intervals: Bayesian models yield the full posterior distribution of all parameters, and all quantities derived from those parameters, including the predicted values. This allows for full propagation of uncertainty through all stages of post-processing and analysis [@beck_multi-scale_2022]. Moreover, the use of additive smoothing splines permits a description of time series using multiple nonlinear components, which can yield a more nuanced understanding of differences in lead concentrations over time.  

# Materials and methods  

## Model distribution system  

The model system comprised three pipe arrays (Figure S1), each with five pipes:  

1. A 9.4 m, 1/2" ID lead pipe (Pb #1).
2. A duplicate of (1), Pb #2.
3. A 3 m, 1/2" ID lead pipe coupled galvanically to a 6.4 m, 1/2" ID copper pipe.
4. A 9.4 m, 1/2" ID copper pipe with twenty-two 50/50 lead-tin solder joints ("Cu/Pb-Sn") (not discussed here).
5. A 9.4 m, 1/2" nominal internal diameter (ID) copper pipe (not discussed here).

All plumbing was new at the time of installation, and lead pipes were acquired from Canada Metals Eastern (ASTM B29, 99.94% pure lead). Each array was preceded in the flow path by a 3.6 m, 3" ID ductile iron pipe, and system pressure was approximately 40 psi. 

The model system was conditioned from Sept. 2017 to Mar. 2018 using treated water from the E. L. Smith Water Treatment Plant in Edmonton, AB, CAN. Afterward, each array received a different dose of phosphoric acid (Table S1): 0 mg P L^-1^ (increasing to 0.5 mg L^-1^ in Jan. 2019), 1.0 mg L^-1^, and 2.0 mg L^-1^ (decreasing to 0.75 mg L^-1^ in Apr. 2019). The latter---a high "passivation" dose followed by a lower "maintenance" dose---is discussed elsewhere as a potential corrosion control strategy [@schock1998lead].

Beginning in Nov. 2020, influent to the model system was partially dechlorinated by blending granular activated carbon filtrate with chlorinated water upstream of the pipe sections. This was done to facilitate a biofilm study not discussed here, and the resulting total chlorine concentrations are summarized in Table S2. In November 2020, 30 cm sections of lead pipe were cut from the galvanic lead-copper pipes for supplementary analysis. These sections were replaced with braided PVC hoses.

Flow through the pipe sections was programmed to approximate typical use, and details are available in Table S3. Samples were collected weekly until Mar. 2021, after which they were collected every two weeks. At each sampling event, 1 L was collected from each pipe after a 6-hour stagnation period. Samples were collected at a flow rate of approximately 3 L min^-1^.

## Water quality analysis  

Lead, iron, aluminum, and manganese were measured by ICP-MS [@sm_3125] with method detection limits estimated at 0.2, 5, 5, and 2 µg L^-1^, respectively. An aliquot of each sample was filtered at 0.45 µm using a polytetrafluoroethylene (PTFE) filter and a vacuum filter apparatus. Losses of dissolved lead by adsorption to PTFE filters have been documented previously [@minning_systematic_2015], which here would tend to bias dissolved concentrations low and particulate concentrations high. In hard waters such as the feedwater for the model system, this bias is likely to be much lower than in soft waters [@minning_systematic_2015].

```{r data-summary}

pl_summ <- model_in %>% 
  filter(pipe_material != "Cu/Pb-Sn") %>% 
  mutate(
    pipe = str_extract(pipe_material, "[^\\s]+"),
    value = 1e3 * lead # convert to µg/L
  ) %>% 
  group_by(pipe) %>% 
  summarize(
    med = median(value),
    lq = quantile(value, .1),
    uq = quantile(value, .9)
  ) %>% 
  ungroup() %>% 
  mutate(across(where(is.double), ~ signif(.x, 2))) %>% 
  pivot_wider(names_from = pipe, values_from = where(is.numeric)) %>% 
  janitor::clean_names()

ts_len <- model_in %>% 
  group_by(location) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  summarize(min = min(n), max = max(n))
  
```

Median lead in full and partial lead pipe sections (i.e., "Pb #1--2" and "Pb-Cu") was `r pl_summ$med_pb` (`r pl_summ$lq_pb`--`r pl_summ$uq_pb`) and `r pl_summ$med_pb_cu` (`r pl_summ$lq_pb_cu`--`r pl_summ$uq_pb_cu`) µg L^-1^, respectively (10^th^--90^th^ percentiles in parentheses). Time series representing effluent from individual pipes ranged in length from `r ts_len$min` to `r ts_len$max` date-value pairs spanning `r with(model_in, as.numeric(difftime(max(date), min(date))))` days.

Temperature was measured using an infrared thermometer, total chlorine [@sm_4500_cl_g] and orthophosphate [@sm_4500_p_e] were measured using a spectrophotometer, and pH was measured using a benchtop meter. Water quality---including alkalinity [@sm_2320b], true colour [@sm_2120c], conductivity [@sm_2510b], fluoride [@sm_4500], total hardness [@sm_2340], and turbidity [@sm_2130b] ---is summarized in Table S4 (all Standard Methods). Colour was quantified after filtration at 0.45 µm, using mixed cellulose ester membrane filters.

```{r figure-2, fig.cap="**Figure 2. (a)** Constant, linear, and generalized additive models (GAMs) fitted to an example (log-transformed) time series from the dataset, along with the residuals from each model. **(b)** Pearson correlation (*r*) between the residuals $\\epsilon$ at time *t* and *t-1*. **(c)** Pearson correlation between the residuals $\\epsilon$ at time *t* and *t-k*, where *k* is the lag and ranges from 0--21. The grey shaded regions represent $\\pm1.96/\\sqrt{n}$, or an approximate 95% confidence bound on the autocorrelation function of an uncorrelated series."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-2.png"))
```

## Model selection    

Comparisons of corrosion control treatments are often aided by a statistical model, and typical choices in pipe loop studies include constant (*e.g.*, *t*-test) and linear models. But when applied to an example time series from our dataset (Figure 2a), both of these models violate a key assumption: the independence of model residuals. 

Lack of independence is apparent in Figure 2b: the residual of either model at time *t*, $\epsilon_t$, is correlated with the residual at time *t-1*, $\epsilon_{t-1}$. This can be extended to include the residual at time *t-k*, $\epsilon_{t-k}$, where *k = 1...21*, yielding the autocorrelation function (Figure 2c). Independent residuals yield autocorrelation functions that remain close to zero, whereas correlated residuals yield autocorrelation functions exhibiting a pattern: decay or oscillation, for instance. We assume here that the example time series is a regular sequence, but in this case, that is only an approximation, and we relax it in the next section.

```{r figure-3, fig.cap="**Figure 3.** The unweighted (cubic) basis functions of *x* on which *log*([Pb]) is regressed, and the same functions after weighting by the model coefficients. The (centered) model fit, or the sum of the weighted basis functions (equation 2), is superimposed in black."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-3.png"))
```

The generalized additive model (GAM) does better than the constant or even the linear model in accounting for autocorrelation in the data (Figure 2). This is because it accounts for non-linear patterns that the simpler models ignore [@trueman_seasonal_2022; @murphy_generalized_2019]. GAMs can also be thought of as linear models, but instead of regressing y on x, we regress y on *functions* of x (cubic functions, for example, as in Figure 3). 

$$(1)~~y = \beta_{0} + f(x_t) + \epsilon_t$$ 
where $f(x_t)$ is a smooth function of $x_t$,

$$(2)~~f(x_t) = \sum_{j=1}^kb_j(x_t)\beta_j$$
$b_j(x_t)$ are the functions of $x_t$ on which $y$ is regressed, $\beta_j$ are the model coefficients, and $\epsilon_t$ is the error term. We fitted the example GAM in Figures 2--3 using the R package *mgcv* [@mgcv], which uses penalized likelihood maximization instead of ordinary least squares to choose coefficients while protecting against overfitting.

### Residual autocorrelation 

Often, even a flexible model---such as a GAM---fails to account for residual autocorrelation in a time series, in which case it is possible to relax the independence assumption and model the residuals as an *autoregressive* process. A very common model is the first-order autoregressive (AR(1)) process:

$$(3)~~\epsilon_t = \phi\epsilon_{t-1} + \omega_t$$
where $\epsilon_t$ is the residual at time $t$, $\phi$ is the autoregressive parameter, and $\omega_t$ is an independent draw from a continuous---typically Gaussian---probability distribution. 

First-order autocorrelation can be approximated as the correlation between the lagged and unlagged residuals, $\epsilon_t$ and $\epsilon_{t-1}$. A reasonable estimate of $\phi$ for the linear model residuals in Figure 2b, then, would be *r*. Unmodeled positive autocorrelation, as in Figure 2b-c, overstates the precision of parameter estimates, and so it should be either eliminated via model selection or taken into account explicitly. Here, we chose to analyze the full length of each time series---including the conditioning period---to best estimate the autocorrelation structure. 

While equation (3) is limited to time series that are regularly observed, it can be generalized to an irregular sequence of observations as a continuous-time first-order autoregression [@simpson_modelling_2018]. This more general model has the following autocorrelation function:

$$(4)~~h(s, \phi) = \phi^s,~s\geq0,~0 \leq \phi \leq1 $$

In equation $(4)$, $s$ represents the separation in time between successive observations. Autocorrelation, then, decays exponentially in time; if two observations are spaced far enough apart, they are approximately independent. Given the irregular spacing of observations in our data, we modeled autocorrelation using equation $(4)$.

## Model description  

To compare corrosion control treatments using data from the model distribution system, we fitted separate GAMs with continuous-time first-order autocorrelated errors to the particulate (>0.45 µm) and dissolved (<0.45 µm) lead time series. Particulate lead was determined as the difference between total and dissolved lead. Particulate lead concentrations less than the detection limit of 0.2 µg L^-1^ were left-censored, and particulate lead concentrations representing the difference between an observed (total) and left-censored (dissolved) concentration were interval-censored. The upper bound of the interval was set as the total lead concentration, implying zero dissolved lead. The lower bound was set as the total lead concentration less the detection limit, implying a dissolved lead concentration equal to the detection limit. Given their impractically high censoring rates (up to 96%), time series representing effluent from soldered copper pipe sections were not modeled. 

Model code was written in Stan [@stan2021; @rstan], a C++ package for Bayesian inference using Markov chain Monte Carlo (MCMC) methods. We generated a code template using the R package `brms` [@brms; @brms_adv] and modified it to specify the continuous-time autocorrelation structure defined in equation $(4)$. We used a suite of R packages [@tidyverse; @nada; @assertr; @janitor; @datatable; @patchwork; @posterior; @ggdist; @wesanderson; @ggh4x; @broom; @ggtext], and bespoke functions used to fit the model and process the results are documented on GitHub [@bgamcar1]. The data and R code necessary to reproduce the analysis are available in a separate repository [@compare_cct].

```{r figure-4, fig.cap="**Figure 4. (a)** Seasonal component of the trend in dissolved lead. **(b)** Global multi-year component of the trend in dissolved and particulate lead. **(c)** Group-level (i.e., pipe-specific) multi-year trends in dissolved and particulate lead, representing the deviations of each time series from the global multi-year trend. In panels **(a--b)**, shaded regions span the middle 95% of the posterior distribution, and 200 draws from that posterior are superimposed in blue. All plots are shown on the transformed scale and centered."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-4.png"))
```

The models included one-dimensional global smoothers describing multi-year variation in lead across all time series (Figure 4b). The model of dissolved lead also included a global smoother describing seasonal variation (Figure 4a). And while the model assumes that seasonality strength does not vary over time, some previous work has suggested that orthophosphate may damp seasonal variation in lead [@colling_measurement_1987]. This effect could be incorporated by allowing the seasonal smoother to vary with orthophosphate dose. 

Both models included group-level smoothers describing multi-year variation in lead release from each pipe (Figure 4c), a hierarchical structure that is discussed elsewhere [@pedersen_hierarchical_2019]. The multi-year smoothers were thin-plate regression splines and the seasonal smoother was a cyclic cubic regression spline [@mgcv]. To speed up computation, the response variable was log-transformed and then scaled to have zero mean and unit variance. And while it is omitted here, total lead could be predicted using the same model structure as dissolved lead.

Time series representing lead release to drinking water tend to feature extreme values caused by particulate or colloidal lead. Even in 0.45 µm filtrate (i.e., dissolved lead), small colloids can sometimes elevate lead concentrations well above solubility limits [@king_role_2022]. These "outliers" can severely bias parameter estimates unless they are accounted for. And since our dataset was impacted by extreme lead release events, we used a Student *t* likelihood in place of the usual Gaussian likelihood to limit the influence of extreme values [@brms; @brms_adv].

Applying Bayes' theorem [@mcelreath_statistical_2016], the joint probability distribution of the model parameters, conditional on the data (i.e., the *posterior*), is proportional to product of the likelihood---the probability of the data, conditional on the model parameters---and the prior (i.e., the probability distribution of the model parameters uninformed by the data). 

<!-- $$\begin{align} -->
<!-- P(\theta|D) \propto P(D|\theta)P(\theta) \\ -->
<!-- posterior \propto likelihood \times prior \\ -->
<!-- posterior = P(\theta | D) \\ -->
<!-- likelihood = P(D | \theta) \\ -->
<!-- prior = P(\theta) -->
<!-- \end{align}$$ -->

The transformed dissolved or particulate lead time series, $y_t$, were modeled as follows:

$$
(5)~~
\begin{align}
likelihood: \\
y_t | censored_t = 0 \sim T(\mu_t,\sigma,\nu) \\ 
y_t | censored_t = 1 \sim F(\mu_t,\sigma,\nu) \\
y_t | censored_t = 2 \sim G(\mu_t,\sigma,\nu) \\
\\
model: \\
\mu_t = \alpha_{pipe_i} + \sum_{j=1}^{n}f_j(t) + \phi^s r_{t-s} \\
priors: \\
\sigma \sim T(0, 2.5, 3) \\
\nu \sim Gamma(2,0.5) \\
\phi \sim N(0.5, 0.25) \\
\end{align}
$$
 
where $T$ represents the Student *t*-distribution with mean $\mu_t$, standard deviation $\sigma$, and degrees-of-freedom parameter $\nu$, determining the difference between the *t*-distribution and a Gaussian with the same $\mu$ and $\sigma$. ($Gamma$ and $N$ represent the gamma and Gaussian distributions.)

Left-censored observations are indicated by the variable $censored = 1$ and were modeled using $F(x)$, the cumulative Student *t*-distribution (*i.e.*, $P(X \leq x)$, the probability that, given a set of distributional parameters, a random variable $X$ is equal to the censoring limit, $x$, *at most*) [@stan2021; @mcelreath_statistical_2016]. Interval-censored observations are indicated by $censored = 2$ and were modeled using $G(x, y)$, or $P(x \lt X \leq y) = F(y) - F(x)$, where $x$ and $y$ are the lower and upper limits, respectively. Parameters, then, were estimated without imputation of nondetects: at each iteration of the MCMC algorithm, censored observations factor into the computed posterior via the cumulative probability distribution, $F(x)$, only.

The group-level intercepts $\alpha_{pipe_i}$ (i.e., the pipe-specific average responses) are defined as follows:

$$
(6)~~
\begin{align}
\alpha_{pipe_i} \sim N(\alpha, \sigma_\alpha)~~[adaptive~prior] \\
\alpha \sim T(0.1, 2.5, 3)~~[prior~on~average~pipe] \\
\sigma_{\alpha} \sim T(0, 2.5, 3)~~[prior~on~\sigma~of~pipes] \\ 
\end{align}
$$
The autocorrelation coefficient $\phi^s$ is defined in equation $(4)$, and $r_{t-s}$ is the GAM residual at the previous time step, $t-s$; $r_{t-s} = y_{t-s} - \alpha_{pipe_i} - \sum_{j=1}^{n}f_j(t-s)$. The $f_j(t)$ are smooth spline functions of time that comprise the GAM, and each of the $n$ smoothers takes the following form:

$$
(7)~~
\begin{align}
generalized~additive~model~(GAM): \\
f_j(t) = X_j\beta_j + Z_jb_j \\
\\
priors~for~GAM~coefficients: \\
\beta_j \sim T(0, 2.5, 3)~~[unpenalized] \\
b_j \sim N(0, \sigma_b)~~[penalized] \\
\sigma_b \sim N(0, 0.5) (seasonal~smoother) \\
\sigma_b \sim T(0, 2.5, 3) (global,~group-level~smoothers) \\ 
\end{align}
$$

where $Z_j$ and $X_j$ are matrices representing the penalized and unpenalized basis functions evaluated at time $t$; and $\beta$ and $b_j$ represent the corresponding spline coefficient vectors ($\beta$ is $1\times1$, corresponding to a single unpenalized basis function included in the global multi-year trend). The priors on $\sigma_b$ help to prevent overfitting by penalizing complexity in the fitted smooth terms [@mgcv]. And while the chosen priors did help with model convergence, they did not exert a strong influence on the posterior (Figure S2); the likelihood---representing `r nrow(model_in)` observations in each model---was overwhelmingly influential. A summary of the fitted models, including convergence statistics and effective sample sizes, is provided in Figure S3 and S4.  

### Estimating rates of change    

We estimated the first derivative of the global multi-year smoothers using a finite difference method. Specifically, we generated 4000 posterior predictions of the smooth trend along a regular sequence spanning the date range of the data. This was repeated after adding $\delta = 0.001$ (~$1/3$ of a day) to each value in the sequence. The difference between the grid of posterior predictions evaluated at $t$ and $t+\delta$, divided by $\delta$, approximates the instantaneous rate of change after accounting for seasonal variation, inter-pipe variation, and autocorrelation.

### Model parameters and diagnostics  

Residuals from the two models were approximated well by the estimated residual error distribution (Figure 5a). Furthermore, models fitted to a draw from the posterior predictive distribution---that is, to simulated observations---yielded similar parameters to those of the original models (Figures S5--7).

```{r figure-5, fig.cap="**Figure 5. (a) ** Histograms representing the median of 4000 residual draws from the models; the theoretical densities (red curves) are calculated from the posterior medians of the distributional parameters (i.e., $\\sigma$, $\\nu$) from each model. **(b)** Density of first-order autocorrelation, estimated using the Spearman rank correlation coefficient and 4000 residual draws from the model including and excluding the continuous-time first-order autocorrelation term (GAM and CAR(1), respectively). Estimates were generated using an augmented dataset where censored observations were imputed via posterior prediction. **(c)** Posterior distributions of $\\phi$, the autocorrelation coefficient. **(d)** Pareto *k* shape parameters, which estimate the influence of each observation on the posterior distribution."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-5.png"))
```

The continuous-time autocorrelated error term was successful in capturing residual first-order autocorrelation, estimated in Figure 5b using the Spearman rank correlation coefficient as a measure that is robust against outliers. Since the difference between model predictions and the censoring limit is not an accurate estimate of residual model error, we simulated residuals for model assessment by imputing censored values with posterior predictions and computing the residuals using the augmented dataset. Simulated residuals exhibited minimal autocorrelation, while predictions that excluded the autocorrelation term yielded much stronger residual autocorrelation. The distribution of the autocorrelation coefficient for each model, $\phi$, is shown in Figure 5c, and simulated residuals as a function of time are shown in Figure S8.

The posterior predictive distribution was also robust against extreme values (Figure 5d): the Pareto-*k* values shown here represent the influence of individual observations on the posterior distribution, and values below 0.7 are considered moderately influential (at most), yielding reliable estimates of out-of-sample predictive accuracy (see *Comparing corrosion control treatments* below) [@loo; @loo_paper]. Here, all Pareto-*k* values were below 0.5.

# Results and discussion  

## Comparing corrosion control treatments  

Time series of particulate and dissolved lead featured prominent negative trends after the introduction of orthophosphate, followed by an extended period of relative stability (Figure 6). The dissolved lead time series were seasonal, with maximum levels in late summer and minimum levels in early spring (Figure 4a). 

```{r figure-6, fig.cap="**Figure 6.** Time series of dissolved and particulate lead representing three orthophosphate dosing protocols (columns) and two pipe configurations (rows; the full lead pipe configuration---Pb #1--2---is duplicated). The expected value of the posterior predictive distribution (*i.e.*, $\\mu_t$ in Equation 5) is summarized by the median (blue and red lines) and the 2.5--97.5^th^ percentiles (red/blue shaded regions). The grey shaded region at the left side of each panel represents the conditioning period common to all pipe sections, the yellow shaded bands represent brief periods when orthophosphate dosing was interrupted, and ticks at the top of each panel represent values outside the plot limits. Other significant disturbances are labeled, as described in the methods section (see *Model distribution system*)."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-6.png"))
```

Posterior predictions from the models---$\mu_t$ in Equation $(5)$---can be compared to evaluate the orthophosphate dosing protocols. Here we compared the 0--0.5 mg P L^-1^ with the 1 mg P L^-1^ and the 1 mg P L^-1^ with the 2--0.75 mg P L^-1^ dosing protocols over time by considering their ratios. This highlights an advantage of the Bayesian approach---straightforward error propagation for quantities derived from the posterior distribution of the model parameters [@korner_nievergelt_bayesian_2015].

The three dosing protocols yielded distinct lead release distributions over most of the study, and the difference between the lowest orthophosphate dose and the other two is particularly apparent (Figure 7). The ratio of dissolved Pb concentrations at a P ratio of 0:1---comparing the 0 mg P L^-1^ control with the 1 mg P L^-1^ dose---peaked at `r signif(fig7_summ$.epred, 3)` with a 95% credible interval of `r signif(fig7_summ$.lower, 3)`--`r signif(fig7_summ$.upper, 3)` (Figure 7a). That is, lead release at 0 mg P L^-1^ was as much as 31 times higher than lead release at 1 mg P L^-1^.

The dissolved Pb ratio declined following the introduction of orthophosphate at 0.5 mg P L^-1^ (i.e., at a 0.5:1 P ratio), but its 2.5th percentile---the lower bound of the 95% credible interval---remained above 1 with a single brief exception. This highlights the superior corrosion control performance of 1 mg P L^-1^ over both 0 and 0.5 mg P L^-1^ and is consistent with expectations based on geochemical solubility models [@schock1996corr].

Pb ratios comparing the 1 and 2--0.75 mg P L^-1^ protocols exhibited a more nuanced pattern (Figure 7b). As a comparison of either particulate or dissolved lead concentrations, the Pb ratio at a 1:2 P ratio was less than one, meaning that 2 mg P L^-1^ caused excess lead release relative to the 1 mg P L^-1^ dose. This likely occurred in the dissolved fraction as small colloids [@trueman_characterizing_2019; @li_impact_2020; @lytle_lead_2020]. 

The transition from 2--0.75 mg P L^-1^ reversed this pattern: the dissolved and particulate Pb ratios at the 1:0.75 P ratio were largely greater than one, meaning greater lead release at the 1 mg P L^-1^ dose. A high dose of 2 mg P L^-1^, then, presumably caused a scale layer to form that ultimately released less lead---in both fractions---than its counterpart formed at 1 mg P L^-1^. This is despite being exposed to a lower orthophosphate concentration in the latter half of the study (0.75 mg P L^-1^), and it highlights a potential advantage and drawback of the passivation-maintenance dosing strategy. That is, a high passivation dose may cause excess lead release in the short term---likely due to particle-generating mechanisms [@lytle_lead_2020; @zhao_formation_2018]---while ensuring that a lower maintenance dose is either more effective or effective sooner than it otherwise might be.

```{r figure-7, fig.cap="**Figure 7.** Ratios of posterior predictions comparing **(a)** 0--0.5 with 1 mg P L^-1^ (numerator and denominator, respectively) and **(b)** 1 with 2--0.75 mg P L^-1^. The bold black/red line represents the median of the posterior distribution and the shaded grey region spans the 95% credible interval; black and red indicate portions of the series where the interval included and excluded, respectively, a ratio of 1 (i.e., equality). A random sample of 200 posterior draws is superimposed in blue."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-7.png"))
```

## Modeling autocorrelation   

Autocorrelation models the dependence of observations on previous observations, or the response of the series at time $t+s$ to a shock at time $t$. The effect of the autocorrelated error term here is most evident in the response of the model to high particulate lead release after short sections of lead pipe were removed from the lead-copper pipe couples in Nov. 2020 ("Pb-Cu", Figure 6). While the time-varying mean $\mu_t$ exhibits pronounced spikes corresponding to particle release events, the underlying GAM remains smooth (Figure 4). That is, extreme and sustained deviations from typical behavior are generally captured by the error term (but still reflected in model predictions: see Figure 6 and equation 5).  

Accounting for autocorrelation improved the predictive accuracy of the models, assessed here using approximate leave-one-out cross-validation on the full dataset. Approximate leave-one-out cross-validation estimates the expected log pointwise predictive density---a metric of model accuracy---for new observations not used to fit the model [@loo; @loo_paper; @mcelreath_statistical_2016]. We applied it to the particulate and dissolved lead models with continuous-time autoregressive errors and also to identically-specified models with independent errors. The autoregressive error models yielded higher expected log pointwise predictive densities (i.e., greater accuracy), exceeding the independent error models in this metric by 206 and 47 (dissolved and particulate lead models, respectively). 

## Trends in particulate lead release 

Over much of the study, the dissolved fraction (<0.45 µm) dominated total lead release (Figure 6). During the conditioning period in particular---before orthophosphate was introduced---particles represented a minor contribution. Orthophosphate treatment caused a sharp decrease in dissolved lead (<0.45 µm) and a concomitant increase in the particulate fraction, which is consistent with previous observations and geochemical models [@dore_study_2019; @lytle_lead_2020; @zhao_formation_2018; @abokifa_modeling_2017; @ng_new_2018; @li_controlling_2020]. Given the prominent seasonality in dissolved lead release, the particulate fraction exhibited inverse seasonality, with higher particulate fractions in winter (Figure 6). The increase in particulate lead in the final weeks of the study period is not easily explained, but it may be related to increasing feedwater aluminum concentrations (Figure S9)---previous work has shown that aluminum and orthophosphate interact to increase particulate lead release [@trueman_seasonal_2022].

## Identifying stability    

Effluent lead concentrations in pipe loop studies typically exhibit a pronounced negative trend after commissioning, followed by relative stability for the remainder of the study [@wysock_statistical_1995], assuming other inputs to the system remain constant. This general pattern is represented in our model by the global multi-year trend (Figure 4b), which excludes pipe-specific and seasonal water quality variation. The stability of a pipe array---accounting for effluent from all pipes in the study---can be evaluated by considering the rate of change in this global term. Here, dissolved and particulate lead concentrations in pipe loop effluent declined significantly in the first year of operation as the system stabilized following commissioning (Figure 8a). Both fractions exhibited positive and negative trends in subsequent years that are difficult to explain, but they may be a response to nonseasonal changes in water quality over the study (see *Trends in particulate lead release*).

```{r figure-8, fig.cap="**Figure 8. (a) ** The global multi-year smoother (*f*~global~(t)) and its estimated first derivative (*f'*~global~(t)). A random sample of 200 curves/slope estimates is superimposed, and both sets of lines are underlain by shaded regions covering the middle 95% of the respective posterior distributions. The median of the global trend is shaded red when the 95% credible interval around the local slope does not include zero. **(b--c)** Iron and water temperature, both measured in pipe rack influent, exhibited comparable seasonal patterns to lead, the latter described by the seasonal term in the GAM. Ticks at the top and bottom edges of the plot in **(b)** represent anomalously high and left-censored iron concentrations, respectively."}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-8.png"))
```

The variation in dissolved lead captured in Figure 8a neglects seasonality by design. And while the seasonal component of the model (Figure 8b) is described as a function of time (ordinal day), this is a proxy for the physical and chemical inputs that are expected to have caused it. The true seasonal relationship is probably complex and difficult to determine from the study data, but temperature and influent iron concentration are plausible drivers: both varied seasonally and have been shown to impact lead release (Figure 8b--c) [@masters_increased_2015; @masters_seasonal_2016; @trueman_galvanic_2017; @trueman_understanding_2016]. And while dissolved organic carbon has also been shown to impact lead release [@korshin_influence_2005; @lin_release_2008; @king_role_2022], true colour---a proxy for dissolved organic carbon [@redden_chemical_2021]---was not strongly seasonal (Figure S9). 

# Conclusion  

Pipe loop study data can be difficult to analyze, owing to non-linear time trends, seasonality, autocorrelation due to repeated measurements of pipe effluent, irregular sampling frequency, extreme particulate metals concentrations, and left-censoring, or values below the detection limit. To address these difficulties, we propose a robust Bayesian generalized additive model with continuous-time first-order autoregressive errors. With this approach, there is no need to impute non-detects, assume linearity, or treat outliers specially. Moreover, the model accounts for the reduced information content in autocorrelated observations. 

Our approach can be modified to suit the needs of diverse analyses. While time is the sole independent variable here, water quality parameters can easily be added as predictors if inferences concerning their effects are of interest. Moreover, any parameter in the likelihood can be modeled---including the standard deviation if model residuals are heteroskedastic. The model is equally useful for other problems featuring the partially-censored, irregularly-sampled, autocorrelated time series common in water quality analysis [@helsel_statistical]. But like many Bayesian models, this one is computationally-intensive to fit and would be difficult to implement in real-time applications.

We demonstrate it here using data from a four-year pipe loop study and we use the model to compare orthophosphate dosing protocols and analyze time trends. The additive smooth terms comprising the model yield an informative decomposition of pipe loop time series and a more nuanced comparison of corrosion control treatments. 

The pipe loop system responded strongly to orthophosphate treatment, as evident in the decreasing global trend during the first year of operation and the large difference in lead release between the 0 and 1 mg P L^-1^ dose. But the effect of orthophosphate dose was complex: lead release at 1 mg P L^-1^ was lower than at 0.5 mg P L^-1^ but higher than at 0.75 mg P L^-1^. We attribute the superior performance of the 0.75 mg P L^-1^ dose to an initial high dose of 2 mg P L^-1^. On the other hand, the initial 2 mg P L^-1^ dose caused excess lead release, highlighting an important trade-off that should be considered in applying a passivation-maintenance (high-low) dosing strategy. And since high orthophosphate doses may generate small lead-orthophosphate colloids/nanoparticles that are difficult to remove from drinking water [@lytle_lead_2020], the 1 mg P L^-1^ dose may be a better option in this case. The effect of orthophosphate treatment was also complicated by pronounced seasonal variation in lead release, with a maximum in late summer and minimum in early spring. This seasonal pattern may have multiple drivers: iron and water temperature, for instance, were also seasonal.  

Given that pipe loop studies are expected to remain important for drinking water quality management, time series analysis will be  necessary for reliable statistical analysis of the data they generate. Methods that do not account for the effect of repeated measurements---and the reduced information content that results from autocorrelation---are likely to be less useful, and may even be misleading. Methods should be flexible enough to account for nonlinear time trends, and they should be robust against extreme values. And since the goal of pipe loop studies is often to minimize the release of lead and other metals into drinking water, concentrations may fall below the analytical range for a given analyte. The most useful statistical methods, then, will be well-suited to modeling censored data.

# Acknowledgements  

This work was supported by Mitacs, through the Mitacs Accelerate Program (Reference # IT23352), and NSERC, through an Industrial Research Chair program (Grant # IRCPJ: 349838-16) and a Postdoctoral Fellowship (E. Dor&eacute;). We thank David Redden and Paul Bjorndahl for providing comments on a draft of the manuscript. We also acknowledge EPCOR's analytical operations team for water quality analysis and their process development team for operating the pipe loops.

# Associated content  

## Supporting information

The Supporting Information is available free of charge via the internet at http://pubs.acs.org.

Additional description of the pipe loop study and the statistical model, including model summaries, convergence statistics, and a comparison of different prior choices.

# References  

<div id="refs"></div>

# TOC graphic  

```{r toc-art}
knitr::include_graphics(here::here("Rmarkdown/figures/figure-toc.png"))
```
